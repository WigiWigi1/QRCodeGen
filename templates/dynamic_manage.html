<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic QR Links — ColorQR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
        content="Manage your Dynamic QR codes: update target URLs, copy links, and open QR images."/>
  <link rel="icon" type="image/png" href="/static/favicon.png"/>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">

  <style>
    .dyn-wrapper {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .dyn-card {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 1rem 1.1rem;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
    }

    .dyn-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
      margin-bottom: .6rem;
    }

    .dyn-label-input {
      width: 100%;
      max-width: 220px;
      padding: 0.3rem 0.55rem;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
      font-family: inherit;
      box-sizing: border-box;
    }

    .dyn-id-pill {
      font-size: 0.8rem;
      color: #6b7280;
      background: #f3f4f6;
      border-radius: 9999px;
      padding: 0.15rem .6rem;
      white-space: nowrap;
    }

    .dyn-row {
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .dyn-row-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
    }

    .dyn-short-link a {
      color: #2563eb;
      text-decoration: none;
      word-break: break-all;
      font-size: 0.9rem;
    }
    .dyn-short-link a:hover {
      text-decoration: underline;
    }

    .dyn-url-input {
      width: 100%;
      padding: 0.35rem 0.6rem;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
      font-family: inherit;
      box-sizing: border-box;
    }

    .dyn-meta {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .dyn-footer {
      margin-top: 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .dyn-footer-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .dyn-open-link {
      color: #2563eb;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .dyn-open-link:hover {
      text-decoration: underline;
    }

    .dyn-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .dyn-save-btn {
      padding: 0.3rem 0.9rem;
      border-radius: 9999px;
      border: 1px solid #10b981;
      background: #ecfdf5;
      color: #047857;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .dyn-delete-btn {
      padding: 0.3rem 0.9rem;
      border-radius: 9999px;
      border: 1px solid #ef4444;
      background: #fef2f2;
      color: #b91c1c;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .dyn-status {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.2rem;
      min-height: 1em;
    }

    @media (max-width: 640px) {
      .dyn-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .dyn-footer {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="header">
  <div class="logo">
    <a href="/" class="logo-link">ColorQR</a>
    {% if is_pro %}
      <span class="badge badge-pro" title="Pro active">Pro</span>
    {% elif is_one_time %}
      <span class="badge badge-ot" title="One-Time Access active">One-Time</span>
    {% endif %}
  </div>
  <div class="user-box">
    {% if user %}
      {% if user.picture %}<img src="{{ user.picture }}" alt="avatar">{% endif %}
      <span class="user-email">{{ user.email }}</span>
      <a class="logout-btn" href="/logout">Logout</a>
    {% else %}
      <a class="login-btn" href="/login">Login with Google</a>
    {% endif %}
  </div>
</div>

<nav>
  <a href="/"        class="{{ 'active' if active=='home'    else '' }}">Home</a>
  <a href="/about"   class="{{ 'active' if active=='about'   else '' }}">About</a>
  <a href="/pricing" class="{{ 'active' if active=='pricing' else '' }}">Pricing</a>
  <a href="/faq"     class="{{ 'active' if active=='faq'     else '' }}">FAQ</a>
  <a href="/blog"    class="{{ 'active' if active=='blog'    else '' }}">Blog</a>
  <a href="/contact" class="{{ 'active' if active=='contact' else '' }}">Contact</a>
</nav>

<div class="page-container">
  <div class="card">
    <h2 style="margin-top:0;text-align:center;">Dynamic QR Links</h2>
    <p style="text-align:center;color:#4b5563;margin-bottom:1.5rem;">
      Each Dynamic QR has a permanent short link and its own QR image file.
      You can update the target URL anytime.
    </p>

    {% if links %}
      <div class="dyn-wrapper">
        {% for link in links %}
          <div class="dyn-card" data-id="{{ link.id }}">
            <div class="dyn-header">
              <input
                class="dyn-label-input"
                type="text"
                placeholder="Label (optional)"
                value="{{ link.label or '' }}"
              >
              <span class="dyn-id-pill">ID: {{ link.id }}</span>
            </div>

            <div class="dyn-row">
              <div class="dyn-row-label">Short link</div>
              <div class="dyn-short-link">
                <a href="{{ url_for('dynamic_redirect', id=link.id) }}"
                   target="_blank"
                   rel="noopener">
                  {{ url_for('dynamic_redirect', id=link.id, _external=True) }}
                </a>
              </div>
            </div>

            <div class="dyn-row">
              <div class="dyn-row-label">Target URL</div>
              <input
                class="dyn-url-input"
                type="text"
                value="{{ link.target_url }}"
              >
            </div>

            <div class="dyn-row">
              <div class="dyn-row-label">Created</div>
              <div class="dyn-meta">
                {{ link.created_at.strftime('%Y-%m-%d %H:%M') if link.created_at else '—' }}
              </div>
            </div>

            <div class="dyn-footer">
              <div class="dyn-footer-left">
                  <div style="display:flex;flex-direction:column;gap:0.15rem;">
                    <a href="{{ url_for('dynamic_qr_image', id=link.id) }}"
                       target="_blank"
                       rel="noopener"
                       class="dyn-open-link">
                      Open QR (JPG)
                    </a>
                    <a href="{{ url_for('dynamic_qr_svg', id=link.id) }}"
                       target="_blank"
                       rel="noopener"
                       class="dyn-open-link">
                      Download SVG
                    </a>
                  </div>
                </div>

              <div>
                <div class="dyn-actions">
                  <button type="button"
                          class="dyn-save-btn"
                          data-id="{{ link.id }}">
                    Save
                  </button>
                  <button type="button"
                          class="dyn-delete-btn"
                          data-id="{{ link.id }}">
                    Delete
                  </button>
                </div>
                <div class="dyn-status"></div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p style="text-align:center;color:#6b7280;">
        You don't have any Dynamic QR codes yet.<br>
        Create one on the home page by selecting <strong>Dynamic</strong> and generating your first code.
      </p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {

    // ----- UPDATE -----
    document.querySelectorAll('.dyn-save-btn').forEach(function (btn) {
      btn.addEventListener('click', async function () {
        const id  = btn.dataset.id;
        const card = btn.closest('.dyn-card');
        if (!id || !card) return;

        const labelInput = card.querySelector('.dyn-label-input');
        const urlInput   = card.querySelector('.dyn-url-input');
        const statusEl   = card.querySelector('.dyn-status');

        const targetUrl = (urlInput.value || '').trim();
        const label     = (labelInput.value || '').trim();

        if (!targetUrl) {
          statusEl.textContent = 'Target URL cannot be empty';
          statusEl.style.color = '#b91c1c';
          return;
        }

        statusEl.textContent = 'Saving...';
        statusEl.style.color = '#6b7280';

        try {
          const resp = await fetch('/dynamic/update/' + encodeURIComponent(id), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target_url: targetUrl, label: label })
          });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            statusEl.textContent = data.error || 'Failed to save';
            statusEl.style.color = '#b91c1c';
            return;
          }
          statusEl.textContent = 'Saved';
          statusEl.style.color = '#16a34a';
        } catch (e) {
          statusEl.textContent = 'Unexpected error';
          statusEl.style.color = '#b91c1c';
        }
      });
    });

    // ----- DELETE -----
    document.querySelectorAll('.dyn-delete-btn').forEach(function (btn) {
      btn.addEventListener('click', async function () {
        const id   = btn.dataset.id;
        const card = btn.closest('.dyn-card');
        if (!id || !card) return;

        const ok = confirm(
          'Delete this Dynamic QR?\n\nThe short link /r/' + id + ' will stop working.'
        );
        if (!ok) return;

        try {
          const resp = await fetch('/dynamic/delete/' + encodeURIComponent(id), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            alert(data.error || 'Failed to delete');
            return;
          }
          card.remove();
        } catch (e) {
          alert('Unexpected error while deleting Dynamic QR');
        }
      });
    });

  });
</script>

</body>
</html>
